<style>
    .section { margin: 1rem 0; }
    .field { margin: 0.5rem 0; }
    label { display:block; font-weight:600; }
    #JellyBellyConfigurationPage .emby-input { max-width: 320px; width: 100%; }
</style>

<div id="JellyBellyConfigurationPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-button,emby-input" data-pluginid="f8fa0c88-7b8f-4c21-9da3-62d0fb1b9a54">
    <div data-role="content" class="content">
    <div class="section">
                <h2>JellyBelly Settings</h2>
                <div class="field">
            <label for="jb_maxitems" class="inputLabel" title="Maximum items per row in generated collections.">Max items per row</label>
            <input id="jb_maxitems" class="emby-input" type="number" min="1" max="500" step="1" />
                </div>
                <div class="field">
            <label for="jb_recent" class="inputLabel" title="How many recent items to learn from when building your profile.">Recent items to learn from</label>
            <input id="jb_recent" class="emby-input" type="number" min="1" max="1000" step="1" />
                </div>
                <div class="field">
            <label for="jb_halflife" class="inputLabel" title="Recency decay half life in days.">Half life (days)</label>
            <input id="jb_halflife" class="emby-input" type="number" min="1" max="365" step="1" />
                </div>
            </div>

            <div class="section">
                <h3>Weights</h3>
                <div class="field"><label for="jb_w_finished" class="inputLabel" title="Weight for finished plays.">Finished weight</label><input id="jb_w_finished" class="emby-input" type="number" step="0.05" min="0" max="10" /></div>
                <div class="field"><label for="jb_w_partial" class="inputLabel" title="Weight for partial plays over 40 percent.">Partial over 40 percent weight</label><input id="jb_w_partial" class="emby-input" type="number" step="0.05" min="0" max="10" /></div>
                <div class="field"><label for="jb_w_fav" class="inputLabel" title="Weight for favorite or like.">Favorite or like weight</label><input id="jb_w_fav" class="emby-input" type="number" step="0.05" min="0" max="10" /></div>
                <div class="field"><label for="jb_w_rating" class="inputLabel" title="Weight for rating normalized 0 to 1.">Rating weight</label><input id="jb_w_rating" class="emby-input" type="number" step="0.05" min="0" max="10" /></div>
            </div>

            <div class="section">
                <h3>Toggles</h3>
                <div class="field"><label class="inputLabel" title="Create Because you watched rows."><input id="jb_because" type="checkbox" /> Create Because you watched rows</label></div>
                <div class="field"><label class="inputLabel" title="Create Top picks row."><input id="jb_toppicks" type="checkbox" /> Create Top picks row</label></div>
                <div class="field"><label class="inputLabel" title="Create topic collections from genres, tags, people, studios."><input id="jb_topics" type="checkbox" /> Create topic collections</label></div>
                <div class="field"><label class="inputLabel" title="Use Playback Reporting if installed."><input id="jb_pbr" type="checkbox" /> Use Playback Reporting if installed</label></div>
                <div class="field"><label class="inputLabel" title="Enable collaborative filtering with ML.NET."><input id="jb_cfenabled" type="checkbox" /> Enable collaborative filtering (ML.NET)</label></div>
                <div class="field"><label class="inputLabel" title="Run task once at server startup (for debugging)."><input id="jb_debugstartup" type="checkbox" /> Run at server startup (debug)</label></div>
                <div id="cfblend-wrap" class="field" style="display:none;">
                    <label for="jb_cfblend" title="Blend weight of CF vs TF-IDF. 0 means TF-IDF only, 1 means CF only.">Blend weight for CF vs TF-IDF</label>
                    <input id="jb_cfblend" class="emby-input" type="number" min="0" max="1" step="0.05" />
                </div>
                <div class="field"><label class="inputLabel" title="Enable TMDb enrichment with attribution. Disabled by default."><input id="jb_tmdb" type="checkbox" /> Enable TMDb enrichment</label></div>
                <div class="field"><label class="inputLabel" title="Enable Wikidata enrichment. Disabled by default."><input id="jb_wikidata" type="checkbox" /> Enable Wikidata enrichment</label></div>
                <div class="field"><label class="inputLabel" title="Log results but do not write collections."><input id="jb_dryrun" type="checkbox" /> Dry run</label></div>
            </div>

            <div class="section">
                <div class="field">
                    <label for="jb_minscore" class="inputLabel" title="Minimum score threshold for inclusion.">Minimum score threshold</label>
                    <input id="jb_minscore" class="emby-input" type="number" min="0" max="1" step="0.01" />
                </div>
            </div>

            <div class="section">
                <button id="save" is="emby-button" type="button" class="raised button-submit block emby-button submit">Save</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    define(['jQuery', 'loading'], function ($, loading) {
        'use strict';
        const defaults = {
			MaxItemsPerRow: 30,
			RecentItemsToLearnFrom: 50,
			HalfLifeDays: 30,
			FinishedWeight: 1.0,
			PartialOver40Weight: 0.5,
			FavoriteOrLikeWeight: 0.25,
			RatingWeight: 0.1,
			CreateBecauseRows: true,
			CreateTopPicksRow: true,
			CreateTopicCollections: false,
			UsePlaybackReporting: true,
			EnableCollaborativeFiltering: false,
			CfBlendWeight: 0.5,
			EnableTmdbEnrichment: false,
			EnableWikidataEnrichment: false,
			MinimumScoreThreshold: 0.05,
			DryRun: false,
			DebugRunAtStartup: true
		};

        function setNum(view, id, v) { view.querySelector('#jb_' + id).value = (v == null ? '' : v); }
        function setBool(view, id, v) { view.querySelector('#jb_' + id).checked = !!v; }
        function getNum(view, id) {
            var v = parseFloat(view.querySelector('#jb_' + id).value);
            return isNaN(v) ? undefined : v;
        }
        function getBool(view, id) { return !!view.querySelector('#jb_' + id).checked; }

        function setValues(view, cfg) {
			var v = Object.assign({}, defaults, cfg || {});
            setNum(view, 'maxitems', v.MaxItemsPerRow);
            setNum(view, 'recent', v.RecentItemsToLearnFrom);
            setNum(view, 'halflife', v.HalfLifeDays);
            setNum(view, 'w_finished', v.FinishedWeight);
            setNum(view, 'w_partial', v.PartialOver40Weight);
            setNum(view, 'w_fav', v.FavoriteOrLikeWeight);
            setNum(view, 'w_rating', v.RatingWeight);
            setBool(view, 'because', v.CreateBecauseRows);
            setBool(view, 'toppicks', v.CreateTopPicksRow);
            setBool(view, 'topics', v.CreateTopicCollections);
            setBool(view, 'pbr', v.UsePlaybackReporting);
            setBool(view, 'cfenabled', v.EnableCollaborativeFiltering);
            setNum(view, 'cfblend', v.CfBlendWeight);
            setBool(view, 'tmdb', v.EnableTmdbEnrichment);
            setBool(view, 'wikidata', v.EnableWikidataEnrichment);
            setNum(view, 'minscore', v.MinimumScoreThreshold);
            setBool(view, 'dryrun', v.DryRun);
            setBool(view, 'debugstartup', v.DebugRunAtStartup);
            view.querySelector('#cfblend-wrap').style.display = v.EnableCollaborativeFiltering ? 'block' : 'none';
		}

        function getValues(view) {
            var cfg = {
                MaxItemsPerRow: getNum(view, 'maxitems'),
                RecentItemsToLearnFrom: getNum(view, 'recent'),
                HalfLifeDays: getNum(view, 'halflife'),
                FinishedWeight: getNum(view, 'w_finished'),
                PartialOver40Weight: getNum(view, 'w_partial'),
                FavoriteOrLikeWeight: getNum(view, 'w_fav'),
                RatingWeight: getNum(view, 'w_rating'),
                CreateBecauseRows: getBool(view, 'because'),
                CreateTopPicksRow: getBool(view, 'toppicks'),
                CreateTopicCollections: getBool(view, 'topics'),
                UsePlaybackReporting: getBool(view, 'pbr'),
                EnableCollaborativeFiltering: getBool(view, 'cfenabled'),
                CfBlendWeight: getNum(view, 'cfblend'),
                EnableTmdbEnrichment: getBool(view, 'tmdb'),
                EnableWikidataEnrichment: getBool(view, 'wikidata'),
                MinimumScoreThreshold: getNum(view, 'minscore'),
                DryRun: getBool(view, 'dryrun'),
                DebugRunAtStartup: getBool(view, 'debugstartup')
            };
            // Fill undefined numeric fields with defaults
            var merged = Object.assign({}, defaults, cfg);
            return merged;
        }

        return function (view, params) {
            const pluginId = view.getAttribute('data-pluginid') || 'f8fa0c88-7b8f-4c21-9da3-62d0fb1b9a54';

            function loadConfig() {
                setValues(view, defaults);
                ApiClient.getPluginConfiguration(pluginId).then(function (cfg) {
                    var merged = Object.assign({}, defaults, cfg || {});
                    setValues(view, merged);
                });
            }

            view.addEventListener('viewshow', loadConfig);

            view.querySelector('#jb_cfenabled').addEventListener('change', function () {
                view.querySelector('#cfblend-wrap').style.display = this.checked ? 'block' : 'none';
            });

            view.querySelector('#save').addEventListener('click', function () {
                var cfg = getValues(view);
                loading.show();
                ApiClient.updatePluginConfiguration(pluginId, cfg)
                    .then(function (result) {
                        if (window.Dashboard && typeof window.Dashboard.processPluginConfigurationUpdateResult === 'function') {
                            window.Dashboard.processPluginConfigurationUpdateResult(result);
                        }
                    })
                    .catch(function () { })
                    .then(function () {
                        return ApiClient.getPluginConfiguration(pluginId).then(function (cfg) {
                            var merged = Object.assign({}, defaults, cfg || {});
                            setValues(view, merged);
                        });
                    })
                    .finally(function(){ loading.hide(); });
            });

            // Initial load in case the view is already visible when this module runs
            loadConfig();
            // Also support legacy pageshow event
            $(document).on('pageshow', '#JellyBellyConfigurationPage', loadConfig);
        };
    });
</script>



